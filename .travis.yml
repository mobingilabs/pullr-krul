sudo: required

os:
  - linux

language: go

services:
  - docker

go:
  - master

before_install:
  - go get github.com/golang/dep/...

install:
  - $GOPATH/bin/dep ensure

script:
  - docker --version
  - go test -v $(go list ./... | grep -v /vendor/) -cover
  - if [[ "$TRAVIS_BRANCH" == "$TRAVIS_TAG" ]]; then
      pip install --user awscli;
      export PATH=$PATH:$HOME/.local/bin;
      aws --version;
      eval $(aws ecr get-login --region ap-northeast-1);
      if [[ $TRAVIS_TAG == *"dev"* ]]; then
        export PULLR_IMAGE_NAME=kruldev:${TRAVIS_TAG};
        export SERVICE_NAME=kruldev;
        export TASK_NAME=kruldev;
        export REPOSITORY_NAME=kruldev;
        export CONTAINER_NAME=kruldev;
      else
        export PULLR_IMAGE_NAME=krul:${TRAVIS_TAG};
      fi;
      docker build -t ${PULLR_IMAGE_NAME} .;
      docker images;
      docker tag ${PULLR_IMAGE_NAME} 963826138034.dkr.ecr.ap-northeast-1.amazonaws.com/${PULLR_IMAGE_NAME};
      docker push 963826138034.dkr.ecr.ap-northeast-1.amazonaws.com/${PULLR_IMAGE_NAME};
      sh ./update-ecs.sh;
    else
      go build -v;
    fi
